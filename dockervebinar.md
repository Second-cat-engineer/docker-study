## Вебинар Docker
***

### Что такое Docker? Это платформа для:
- Надежной изоляции приложений;
- Управления окружением приложений;
- Упаковки приложений в контейнеры;
- Доставки и развертывания приложений.


Контейнер - это легковесная виртуализация. Это технология, которая с виртуализацией связана, но в отличие от
виртуальных машин docker контейнеры это неучбольшое изолированное окружение для одного процесса.


### Команда:
> docker run -it nginx bash

Скачивает так называемый образ если он ранее не был скачан. nginx - это образ, скачивает в так называемый regist (реестр).
На локальной машине будет вестись реестр образов.
Что такое образ - это виртуальная файловая система, т.е. множество файлов, папок, которые скомпонованы грубо говоря в 
один архив. Скачивает из docker hub

-it - Интерактивный терминал. Мы хотим скачать не только образ nginx, мы хотим запустить команду bash, причем так, чтоб
с ней взаимодействовать.
Далее происходит следующее:
- docker скачал образ, который называется nginx из официального docker hub;
- docker запустил контейнер. Запустился процесс, и этот процесс видит вокруг себя только вот эту скаченную файловую
систему образа. Он изолирован. Он наши файлы не видит, т.е. образом можно называть файловую систему, которая процессу
подставится и скажет "ты здесь, вокруг тебя ничего нет". Как зеркальная стена. Видит только то, что внутри комнаты
находится. А bash это команда, которую мы внутри запустили.

> docker run -it nginx bash
- docker run - создание и запуск контейнера;
- -it - опции, говорящие о том, что мы хотим интерактивно взаимодействовать с контейнером (оказаться "внутри" него);
- nginx - имя образа контейнера. Образ будет скачан из хранилища образов. Образ, по сути - самостоятельная файловая система;
- bash - команда, которая должна быть выполнена в запущенном контейнере.

Контейнер можно рассматривать как процесс в изолированном окружении с собственной файловой системой

> docker images - образы в локальном реестре

### Запуск не интерактивного режима:
> docker run nginx cat /etc/nginx/nginx.conf

На основе образа был создан и запущен контейнер, в нем выполнена команда и все завершилось.

### Запуск контейнера так, чтобы он исполнил свою собственную команду запуска:
В образе контейнера может быть прописана некая команда, которая после создания контейнера будет выполнена. В случае
с nginx этой командой является запуск.
> docker run nginx

Контейнер сейчас работает, в нем запущен веб-сервер nginx, только у нас нет способа с ним взаимодействовать.

Для взаимодействия необходимо пробросить порты:
> docker run -p 8080:80 nginx

- docker run - создание и запуск контейнера;
- -p 8080:80 - проброс порта. Порт 80 "изнутри" контейнера становится портом 0.0.0.0:8080;
- происходит запуск команды запуска, прописанной в самом контейнере - старт nginx.

Что значит 0.0.0.0? Дело в том что docker маппит эти порты, которые внутри контейнера (80 порт) на указанный порт на
все наши сетевые интерфейсы.

Запуск в фоне:
> docker run -p 8080:80 -d nginx

Команда покажет исполняющиеся сейчас процессы в контейнерах:
> docker ps

Команда покажет все которые когда-либо создавались:
> docker ps -а

Убить контейнер:
> docker kill CONTAINER_ID


## Что же такое контейнер?
- Контейнер - это процесс;
- Docker - запускает этот процесс в изолированном окружении: своя сеть, свой список процессов, своя файловая система;
- Образ - это отдельная виртуальная файловая система, которая "подключается" к контейнеру и процесс работает с ней.

Команда для удаления образа (если нет контейнеров на его базе):
> docker rmi nginx:latest


### Теги
> docker run -it php:7.4-cli

Теги нужны, чтобы указать какую-то конкретную версию, разновидность.


## Управление контейнерами
- docker ps - список запущенных контейнеров;
- docker ps -a - вывод всех контейнеров, включая остановленные (успешно или с ошибкой);
- docker stats - информация о потреблении ресурсов;
- docker logs ID (-f) - вывод логов из указанного контейнера;
- docker kill ID - принудительная остановка указанного контейнера;
- docker pause ID;
- docker unpause ID;
- docker stop ID;


### Docker hub
Docker hub это библиотека образов контейнеров и реестр по умолчанию.
- Публичный репозиторий образов;
- Официальные образы от производителей софта;
- Семантическое версионирование;
- Сертифицированные образы.

Скачиваем образ из официального registry: docker hub в свое локальное хранилище:
> docker pull nginx

Качаем образ my/nginx из registry по адресу myreg:port:
> docker pull myreg:port/my/nginx
***

## Взаимодействие контейнера с "внешним миром"
Два способа пролезть к контейнеру:
- Сеть (проброс портов);
- Файл.

### Сеть.
Мы можем указать какой порт внутри контейнера соответствует какому порту в нашей хост машине, который контейнер запускает.

> docker run -p 80:80 -p 443:443 nginx

Проброс портов. Указываем "внешний порт" (на хост машине) и внутренний (внутри контейнера). В результате контейнер
становится доступен по сети.

Важно понимать: у контейнера нет своего ip адреса. В отличие от виртуальной машины, которая представляет собой
полноценный комп с полноценными сетевыми интерфейсами, у контейнера ничего такого нет. Контейнер это просто процесс,
который выполняется в изолированном окружении, у процесса ip адреса быть не может.


### Файл
> docker run -v ~/project:/app nginx

Проброс папки (или файла) из ФС хост машины в контейнер.
Путь должен быть абсолютным.
Если папка (файл) ранее существовал в контейнере - будут заменены.

### Возможность устанавливать переменные окружения
> docker run -e "HOME=/app" nginx
> docker run --env-file=.env nginx

Запуск контейнера с установкой переменной окружения.
___

> docker run -p 8080:80 -v /var/www/study/docker/vebinar-docker:/app nginx


> docker exec -it ID bash                   

Будет папка app в которой наши файлы.

___


## Подготовка собственного образа

Необходимо создать Dockerfile
~~~dockerfile
FROM php:7.4-cli
# какой образ взять за основу

MAINTAINER second-cat-engineer<yaylyaevsafuan@gmail.com>
# разработчик образа 

WORKDIR /app
# Рабочая директория внутри контейнера

RUN apt update && apt install -y mc
# выполняет определенные нами команды при сборке образа (создает слой)

COPY ./app
# из текущей папки все файлы скопировать в папку app

~~~

> docker build -t my-php .

___

## Docker compose
По сути дела это "пакетный менеджер" для docker, как, к примеру, composer для php.

Использование:
- Описываем конфигурацию контейнеров для нашего проекта в файле docker-compose.yaml;
- Собираем проект, используя команду docker-compose up --build -d;
- Убеждаемся, что нужные нам контейнеры созданы и запущены.



